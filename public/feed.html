<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feed</title>
  <style>
    :root { --bg:#0b0b0f; --text:#f8fafc; --muted:#cbd5e1; --panel:#111216; --border:#1f2937; --accent:#ef4444; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; background: #0e0e12; }
    a { color: var(--accent); text-decoration: none; margin-right: 14px; font-weight: 600; }
    a:hover { text-decoration: underline; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    label { display:block; margin:6px 0 6px; color:var(--muted); font-size: 14px; font-weight: 500; }
    input, button, textarea { padding: 12px 14px; font-size: 14px; border-radius: 10px; border: 1px solid var(--border); background: #0f1117; color: var(--text); width: 100%; }
    .actions { display:flex; gap:10px; margin-top:10px }
    .btn.primary { background:var(--accent); border-color:var(--accent); color:white; font-weight: 600; }
    .btn.primary:hover { background:#dc2626; }
    ul { list-style:none; padding:0; margin:0 }
    li { border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px; background:#0f1117; }
    li:hover { background:#111827; }
    small { color:var(--muted); font-size: 12px; }
    .post-content { margin-bottom: 8px; line-height: 1.5; }
    .post-meta { display: flex; justify-content: space-between; align-items: center; }
    .post-author { font-weight: 600; color: var(--accent); }
    .post-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn-small { padding: 6px 10px; font-size: 12px; border-radius: 6px; border: 1px solid var(--border); background: #dc2626; color: white; cursor: pointer; }
    .btn-small:hover { background: #b91c1c; }
    .empty-state { text-align: center; color: var(--muted); padding: 40px; }
    .empty-state h3 { margin: 0 0 8px; color: var(--text); }
    pre { display:none }
  </style>
  <script>
    let BASE_URL = localStorage.getItem('baseUrl') || window.location.origin;
    let TOKEN = localStorage.getItem('jwt') || '';
    function parseJwt(t){try{return JSON.parse(atob(t.split('.')[1]));}catch(_){return null;}}
    function setBaseUrl(){ const v=document.getElementById('baseUrl').value.trim(); if(v){ localStorage.setItem('baseUrl',v); BASE_URL=v; loadPosts(); }}
    function setToken(t){ TOKEN=t||''; localStorage.setItem('jwt',TOKEN); }
    async function api(path, opts={}){
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
      if(opts.auth!==false && TOKEN) headers['Authorization']='Bearer '+TOKEN;
      const res = await fetch(BASE_URL+path, Object.assign({}, opts, { headers }));
      const json = await res.json().catch(()=>null);
      if(res.status===401||res.status===403){ window.location.href='/login.html'; return {status:res.status,data:json}; }
      return {status:res.status, data:json};
    }
    async function createPost(){
      const content = document.getElementById('content').value;
      if (!content.trim()) return;
      const res = await api('/api/posts',{method:'POST', body: JSON.stringify({content})});
      if(res.status===201){ document.getElementById('content').value=''; loadPosts(); }
      log(res);
    }
    async function deletePost(postId){
      if (!confirm('Are you sure you want to delete this post?')) return;
      const res = await api(`/api/posts/${postId}`, {method:'DELETE'});
      if(res.status===200){ loadPosts(); }
      log(res);
    }
    async function loadPosts(){
      const res = await api('/api/posts');
      const list=document.getElementById('feed'); 
      
      if (!res.data || res.data.length === 0) {
        list.innerHTML = '<div class="empty-state"><h3>No posts yet</h3><p>Start by sending DMs to see posts from your connections!</p></div>';
        return;
      }
      
      list.innerHTML='';
      (res.data||[]).forEach(p=>{
        const li=document.createElement('li');
        const isOwn = p.author?._id === parseJwt(TOKEN)?._id;
        li.innerHTML = `
          <div class="post-content">${p.content}</div>
          <div class="post-meta">
            <span class="post-author">${isOwn ? 'You' : (p.author?.username||'unknown')}</span>
            <small>${new Date(p.createdAt||p.created_at).toLocaleString()}</small>
          </div>
          ${isOwn ? `<div class="post-actions"><button class="btn-small" onclick="deletePost('${p._id}')">Delete</button></div>` : ''}
        `;
        list.appendChild(li);
      });
      log(res);
    }
    function log(obj){ /* hidden in user-facing UI */ }
    function logout(){ localStorage.removeItem('jwt'); window.location.href='/login.html'; }
    window.addEventListener('DOMContentLoaded', ()=>{ 
      if(!TOKEN){ window.location.href='/login.html'; return; }
      document.getElementById('baseUrl').value=BASE_URL; 
      const p=parseJwt(TOKEN); if(p&&p.username){ const el=document.getElementById('welcome'); if(el) el.textContent='Hi, '+p.username; }
      loadPosts(); 
    });
  </script>
</head>
<body>
  <header>
    <div style="flex:1 1 auto; display:flex; gap:14px; align-items:center;">
      <a href="/feed.html">Feed</a>
      <a href="/groups.html">Groups</a>
      <a href="/dms.html">Direct Messages</a>
      <span id="welcome" style="margin-left:auto; color:#cbd5e1"></span>
      <button onclick="logout()" style="margin-left:8px; padding:8px 12px; background:#ef4444; color:#fff; border:0; border-radius:8px; cursor:pointer">Logout</button>
    </div>
    <input id="baseUrl" style="width:280px; display:none" placeholder="http://localhost:3000" />
  </header>
  <div class="container">
    <div class="panel">
      <label>Share something</label>
      <textarea id="content" rows="3" placeholder="What's on your mind?"></textarea>
      <div class="actions"><button class="btn primary" onclick="createPost()">Post</button></div>
    </div>
    
    <div class="panel">
      <label>Your Feed</label>
      <p style="color: var(--muted); font-size: 13px; margin: 4px 0 16px;">Posts from people you've messaged</p>
      <ul id="feed"></ul>
    </div>
  </div>
</body>
</html>