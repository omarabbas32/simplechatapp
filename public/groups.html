<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Groups</title>
  <style>
    :root { --bg:#0b0b0f; --text:#f8fafc; --muted:#cbd5e1; --panel:#111216; --border:#1f2937; --accent:#ef4444; }
    body { font-family: system-ui; margin:0; background:var(--bg); color:var(--text) }
    header { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; background:#0e0e12 }
    a { color:var(--accent); text-decoration:none; margin-right:14px; font-weight:600 }
    a:hover { text-decoration:underline }
    .container { max-width: 980px; margin:0 auto; padding:20px }
    @media (max-width: 768px) { .container { padding: 10px; } header { padding: 10px; } .grid { grid-template-columns: 1fr; } }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px }
    label { display:block; margin:6px 0 2px; color:#94a3b8 }
    input, button { padding:10px 12px; font-size:14px; border-radius:8px; border:1px solid #1e293b; background:#0b1222; color:#e2e8f0; width:100% }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px }
    .actions { display:flex; gap:8px; margin-top:8px }
    .btn.primary { background:var(--accent); border-color:var(--accent); color:white }
    ul { list-style:none; padding:0; margin:0 }
    li { border:1px solid #1e293b; border-radius:8px; padding:10px; margin-bottom:8px; background:#0b1222 }
    .notification { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; }
    .notification.success { background: #22c55e; }
    .notification.error { background: #ef4444; }
    pre { display:none }
  </style>
  <script>
    let BASE_URL = localStorage.getItem('baseUrl') || window.location.origin;
    let TOKEN = localStorage.getItem('jwt') || '';
    function parseJwt(t){try{return JSON.parse(atob(t.split('.')[1]));}catch(_){return null;}}
    function setBaseUrl(){ const v=document.getElementById('baseUrl').value.trim(); if(v){ localStorage.setItem('baseUrl',v); BASE_URL=v; loadGroups(); }}
    async function api(path, opts={}){ const h=Object.assign({'Content-Type':'application/json'},opts.headers||{}); if(opts.auth!==false&&TOKEN) h.Authorization='Bearer '+TOKEN; const r=await fetch(BASE_URL+path,Object.assign({},opts,{headers:h})); const j=await r.json().catch(()=>null); if(r.status===401||r.status===403){ window.location.href='/login.html'; } return {status:r.status,data:j}; }
    function log(o){ /* hidden in user UI */ }
    function logout(){ localStorage.removeItem('jwt'); window.location.href='/login.html'; }
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
    async function createGroup(){ const name=document.getElementById('group_name').value; if(!name.trim()){ showNotification('Please enter a group name', 'error'); return; } const r=await api('/api/groups',{method:'POST',body:JSON.stringify({name})}); if(r.status===201){ document.getElementById('group_id').value=r.data._id; loadGroups(); showNotification('Group created successfully!'); } else { showNotification(r.data?.message || 'Failed to create group', 'error'); } log(r); }
    async function addMember(){ 
      const id=document.getElementById('group_id').value; 
      const uname=document.getElementById('member_username').value; 
      if(!id){ showNotification('Please select a group first', 'error'); return; } 
      if(!uname){ showNotification('Please enter username', 'error'); return; } 
      const body={username:uname}; 
      console.log('Adding member:', { groupId: id, username: uname, body });
      const r=await api(`/api/groups/${id}/add-user`,{method:'POST',body:JSON.stringify(body)}); 
      console.log('Add member response:', r);
      if(r.status===200){ 
        showNotification('Member added successfully!'); 
        document.getElementById('member_username').value = '';
        loadGroupMembers(id);
      } else { 
        showNotification(r.data?.message || 'Failed to add member', 'error'); 
      } 
      log(r); 
    }
    async function sendGroupMessage(){ const id=document.getElementById('group_id').value; const message=document.getElementById('group_message').value; if(!id){ showNotification('Please select a group first', 'error'); return; } if(!message.trim()){ showNotification('Please enter a message', 'error'); return; } const r=await api(`/api/groups/${id}/messages`,{method:'POST',body:JSON.stringify({message})}); if(r.status===201){ document.getElementById('group_message').value=''; showNotification('Message sent successfully!'); } else { showNotification(r.data?.message || 'Failed to send message', 'error'); } log(r); }
    async function loadGroups(){ 
      const r=await api('/api/groups'); 
      const list=document.getElementById('groups'); 
      list.innerHTML=''; 
      if(!r.data || r.data.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:var(--muted); padding:20px;">No groups yet</li>';
        return;
      }
      (r.data||[]).forEach(g=>{ 
        const li=document.createElement('li'); 
        li.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:600; margin-bottom:4px;">${g.name}</div>
              <div style="font-size:12px; color:var(--muted);">${(g.members||[]).length} members</div>
            </div>
            <button onclick="selectGroup('${g._id}', '${g.name}')" style="padding:6px 12px; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer;">Select</button>
          </div>
        `; 
        list.appendChild(li); 
      }); 
      log(r); 
    }
    
    function selectGroup(id, name) {
      document.getElementById('group_id').value = id;
      document.getElementById('group_name').value = name;
      document.getElementById('selected-group').textContent = name;
      showNotification(`Selected group: ${name}`);
      loadGroupMembers(id);
    }
    
    async function loadGroupMembers(groupId) {
      if (!groupId) return;
      try {
        console.log('Loading members for group:', groupId);
        const r = await api(`/api/groups/${groupId}`);
        console.log('Group details response:', r);
        const membersList = document.getElementById('group-members');
        membersList.innerHTML = '';
        
        if (r.data && r.data.members) {
          console.log('Group members:', r.data.members);
          r.data.members.forEach(member => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#0f1117; border-radius:6px; margin-bottom:4px;">
                <span>${member.username || 'Unknown'}</span>
                <button onclick="removeMember('${groupId}', '${member._id}')" style="padding:4px 8px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">Remove</button>
              </div>
            `;
            membersList.appendChild(li);
          });
        } else {
          membersList.innerHTML = '<li style="text-align:center; color:var(--muted); padding:10px;">No members</li>';
        }
      } catch (error) {
        console.error('Error loading group members:', error);
      }
    }
    
    async function removeMember(groupId, memberId) {
      if (!confirm('Are you sure you want to remove this member?')) return;
      // This would need a new API endpoint
      showNotification('Remove member feature needs backend implementation', 'error');
    }
    window.addEventListener('DOMContentLoaded',()=>{ 
      if(!TOKEN){ window.location.href='/login.html'; return; }
      document.getElementById('baseUrl').value=BASE_URL; 
      const p=parseJwt(TOKEN); if(p&&p.username){ const el=document.getElementById('welcome'); if(el) el.textContent='Hi, '+p.username; }
      loadGroups(); 
    });
  </script>
</head>
<body>
  <header>
    <div style="flex:1 1 auto; display:flex; gap:14px; align-items:center;">
      <a href="/feed.html">Feed</a>
      <a href="/groups.html">Groups</a>
      <a href="/dms.html">Direct Messages</a>
      <a href="/login.html" style="margin-left:auto">Auth</a>
    </div>
    <input id="baseUrl" style="width:280px; display:none" placeholder="http://localhost:3000" />
  </header>
  <div class="container">
    <div class="panel">
      <div class="grid">
        <div>
          <label>Group name</label>
          <input id="group_name" />
          <div class="actions"><button class="btn primary" onclick="createGroup()">Create group</button></div>
          <label style="margin-top:14px">Groups</label>
          <ul id="groups"></ul>
        </div>
        <div>
          <div style="background:#0f1117; padding:12px; border-radius:8px; margin-bottom:16px;">
            <label>Selected Group</label>
            <div id="selected-group" style="color:var(--muted); font-size:14px;">No group selected</div>
          </div>
          
          <label>Add Member</label>
          <input id="member_username" placeholder="Enter username" />
          <div class="actions">
            <button onclick="addMember()">Add Member</button>
          </div>
          
          <label style="margin-top:16px;">Send Message</label>
          <input id="group_message" placeholder="Type your message..." />
          <div class="actions">
            <button onclick="sendGroupMessage()">Send Message</button>
          </div>
          
          <label style="margin-top:16px;">Group Members</label>
          <ul id="group-members" style="max-height:150px; overflow-y:auto;"></ul>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

