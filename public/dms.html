<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Omar Eltop — Direct Messages</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* DM page tweaks */
    .dm-wrap{display:flex;gap:16px;min-height:80vh}
    .dm-list{width:320px;background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;overflow:auto}
    .dm-item{padding:10px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .dm-item:hover{background:rgba(255,255,255,0.03)}
    .dm-item.active{background:linear-gradient(90deg,#0f7be6, #0b66d7, rgba(11,102,215,0.08));color:#fff}
    .dm-chat{flex:1;display:flex;flex-direction:column;gap:12px}
    .dm-header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.01);border-radius:10px}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);border-radius:10px}
    .msg{max-width:70%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02)}
    .msg.me{margin-left:auto;background:linear-gradient(90deg,#0f7be6,#0b66d7);color:#fff}
    .composer{display:flex;gap:8px;margin-top:8px}
    .composer input{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .btn{background:#0b66d7;color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .muted{color:#95a3b8;font-size:13px}
    @media (max-width:900px){ .dm-list{width:100%} .dm-wrap{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container app-root" style="max-width:1100px;margin:28px auto">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>Omar Eltop — Direct Messages</h2>
      <div>
        <span id="userLabel" class="muted"></span>
        <button id="logout" class="btn" style="margin-left:8px">Logout</button>
      </div>
    </header>

    <div class="dm-wrap">
      <aside class="dm-list card">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="searchUser" placeholder="Search username or paste user id" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" />
          <button id="openManual" class="btn">Open</button>
        </div>
        <div id="conversations" style="display:flex;flex-direction:column;gap:6px"></div>
      </aside>

      <main class="dm-chat">
        <div id="empty" class="card center muted">Select a conversation to view messages</div>

        <section id="chat" class="card hidden" style="display:flex;flex-direction:column;min-height:520px">
          <div class="dm-header">
            <div>
              <div id="chatTitle" style="font-weight:700"></div>
              <div id="chatSubtitle" class="muted"></div>
            </div>
            <div id="typingIndicator" class="muted"></div>
          </div>

          <div id="messages" class="messages"></div>

          <div class="composer">
            <input id="messageInput" placeholder="Write a message…" autocomplete="off" />
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // DM page script
    (function(){
      const token = localStorage.getItem('token');
      if (!token) { location.href = '/'; return; }

      const userLabel = document.getElementById('userLabel');
      const logout = document.getElementById('logout');
      const conversationsEl = document.getElementById('conversations');
      const searchUser = document.getElementById('searchUser');
      const openManual = document.getElementById('openManual');

      const empty = document.getElementById('empty');
      const chat = document.getElementById('chat');
      const chatTitle = document.getElementById('chatTitle');
      const chatSubtitle = document.getElementById('chatSubtitle');
      const messagesEl = document.getElementById('messages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const typingIndicator = document.getElementById('typingIndicator');

      function jwtPayload(){ try { return JSON.parse(atob(token.split('.')[1])); } catch { return {}; } }
      userLabel.textContent = jwtPayload().username || jwtPayload()._id || 'You';
      logout.onclick = ()=> { localStorage.removeItem('token'); location.reload(); };

      const api = (path, opts={}) => fetch(path, Object.assign({headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}}, opts));

      // Socket.IO with auth
      const socket = io({ auth: { token } });
      socket.on('connect', () => console.log('socket connected', socket.id));
      socket.on('connect_error', e => console.warn('socket err', e && e.message));

      // state
      let currentOther = null;
      let typingTimer = null;

      // load conversation list (if server supports /api/users or /api/dms)
      async function loadConversations(){
        conversationsEl.innerHTML = '<div class="muted">Loading users…</div>';
        try {
          const res = await api('/api/users');
          if (!res.ok) throw new Error('no users api');
          const users = await res.json();
          renderConversations(users.filter(u=>u._id !== jwtPayload()._id));
        } catch (e) {
          conversationsEl.innerHTML = '<div class="muted">No users list. Use the search box to open a DM by id.</div>';
        }
      }

      function renderConversations(users){
        conversationsEl.innerHTML = users.map(u => `
          <div class="dm-item" data-id="${u._id}">
            <div><strong>${escape(u.username||u._id)}</strong></div>
            <div class="muted">${u._id.slice(0,6)}</div>
          </div>
        `).join('');
        conversationsEl.querySelectorAll('.dm-item').forEach(el => el.onclick = ()=> openConversation(el.dataset.id, el));
      }

      openManual.onclick = () => {
        const id = searchUser.value.trim();
        if (!id) return;
        openConversation(id);
      };

      async function openConversation(otherId, el){
        currentOther = otherId;
        // UI
        document.querySelectorAll('.dm-item').forEach(i=>i.classList.remove('active'));
        if (el) el.classList.add('active');
        chatTitle.textContent = 'Conversation';
        chatSubtitle.textContent = `With: ${otherId}`;
        empty.classList.add('hidden');
        chat.classList.remove('hidden');
        messagesEl.innerHTML = '<div class="muted">Loading…</div>';
        // join personal room for direct messages (server should handle)
        socket.emit('join_dm', { toUserId: otherId });
        try {
          const res = await api(`/api/messages/direct/${otherId}`);
          const msgs = await res.json();
          renderMessages(msgs);
          scrollBottom();
        } catch (e) {
          messagesEl.innerHTML = '<div class="muted">Failed to load messages</div>';
        }
      }

      function renderMessages(list){
        messagesEl.innerHTML = (list||[]).map(m=>{
          const me = (m.sender === jwtPayload()._id);
          return `<div class="msg ${me? 'me':''}">${escape(m.content)}<div class="muted" style="font-size:12px;margin-top:6px">${(m.senderName||m.sender)||''} · ${new Date(m.createdAt||m.createdAt||Date.now()).toLocaleTimeString()}</div></div>`;
        }).join('');
      }

      function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

      sendBtn.onclick = sendMessage;
      messageInput.oninput = () => {
        if (!currentOther) return;
        socket.emit('typing', { toUserId: currentOther, isTyping: true });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=> socket.emit('typing', { toUserId: currentOther, isTyping: false }), 900);
      };

      async function sendMessage(){
        const text = messageInput.value.trim();
        if (!text || !currentOther) return;
        messageInput.value = '';
        // optimistic render
        messagesEl.insertAdjacentHTML('beforeend', `<div class="msg me">${escape(text)}<div class="muted" style="font-size:12px;margin-top:6px">You · ${new Date().toLocaleTimeString()}</div></div>`);
        scrollBottom();
        try {
          await api('/api/messages/direct/send', { method:'POST', body: JSON.stringify({ receiverId: currentOther, content: text }) });
          // server should emit new_direct_message; if not, we already show optimistic
        } catch (e) { console.error(e); }
      }

      // socket listeners
      socket.on('typing', payload => {
        if (payload.to === jwtPayload()._id || payload.from === currentOther) {
          typingIndicator.textContent = payload.isTyping ? `${payload.fromName||'Them'} is typing…` : '';
        }
      });

      socket.on('new_direct_message', m => {
        if (!currentOther) return;
        if (m.sender === currentOther || m.receiver === currentOther) {
          messagesEl.insertAdjacentHTML('beforeend', `<div class="msg ${m.sender===jwtPayload()._id? 'me':''}">${escape(m.content)}<div class="muted" style="font-size:12px;margin-top:6px">${(m.senderName||m.sender)||''} · ${new Date(m.createdAt||Date.now()).toLocaleTimeString()}</div></div>`);
          scrollBottom();
        }
      });

      // utils
      function escape(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      // initial
      loadConversations();
    })();
  </script>
</body>
</html>