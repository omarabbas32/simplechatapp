<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Omar Eltop — Groups</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* Group chat page */
    .wrap{display:flex;gap:16px;min-height:80vh;align-items:flex-start}
    .left{width:320px;background:rgba(255,255,255,0.02);padding:14px;border-radius:12px}
    .group-item{padding:10px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .group-item:hover{background:rgba(255,255,255,0.03)}
    .group-item.active{background:linear-gradient(90deg,#0f7be6,#0b66d7);color:#fff}
    .chat-area{flex:1;display:flex;flex-direction:column;gap:12px}
    .header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px}
    .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);border-radius:10px}
    .msg{max-width:75%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02)}
    .msg.me{margin-left:auto;background:linear-gradient(90deg,#0f7be6,#0b66d7);color:#fff}
    .composer{display:flex;gap:8px;margin-top:8px}
    .composer input{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .btn{background:#0b66d7;color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .muted{color:#95a3b8;font-size:13px}
    @media (max-width:900px){ .left{width:100%} .wrap{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container app-root" style="max-width:1100px;margin:28px auto">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>Omar Eltop — Groups</h2>
      <div>
        <span id="userLabel" class="muted"></span>
        <button id="logout" class="btn" style="margin-left:8px">Logout</button>
      </div>
    </header>

    <div class="wrap">
      <aside class="left card">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="newGroupName" placeholder="Create new group" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" />
          <button id="createGroup" class="btn">Create</button>
        </div>
        <div id="groupsList" style="display:flex;flex-direction:column;gap:6px;max-height:540px;overflow:auto"></div>
      </aside>

      <main class="chat-area">
        <div id="noGroup" class="card center muted">Select a group to start chatting</div>

        <section id="groupChat" class="card hidden" style="display:flex;flex-direction:column;min-height:520px">
          <div class="header">
            <div>
              <div id="groupTitle" style="font-weight:700"></div>
              <div id="groupSub" class="muted"></div>
            </div>
            <div id="typing" class="muted"></div>
          </div>

          <div id="groupMessages" class="messages"></div>

          <div class="composer">
            <input id="groupInput" placeholder="Message the group…" autocomplete="off" />
            <button id="groupSend" class="btn">Send</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Group page script
    (function(){
      const token = localStorage.getItem('token');
      if (!token) { location.href = '/'; return; }

      const userLabel = document.getElementById('userLabel');
      const logout = document.getElementById('logout');
      const groupsList = document.getElementById('groupsList');
      const newGroupName = document.getElementById('newGroupName');
      const createGroup = document.getElementById('createGroup');

      const noGroup = document.getElementById('noGroup');
      const groupChat = document.getElementById('groupChat');
      const groupTitle = document.getElementById('groupTitle');
      const groupSub = document.getElementById('groupSub');
      const groupMessages = document.getElementById('groupMessages');
      const groupInput = document.getElementById('groupInput');
      const groupSend = document.getElementById('groupSend');
      const typing = document.getElementById('typing');

      function jwt(){ try { return JSON.parse(atob(token.split('.')[1])); } catch { return {}; } }
      userLabel.textContent = jwt().username || jwt()._id || 'You';
      logout.onclick = ()=> { localStorage.removeItem('token'); location.reload(); };

      const api = (path, opts={}) => fetch(path, Object.assign({headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}}, opts));

      const socket = io({ auth: { token } });
      socket.on('connect', () => console.log('socket connected', socket.id));
      socket.on('connect_error', e => console.warn('socket err', e && e.message));

      let currentGroup = null;
      let typingTimer = null;

      async function loadGroups(){
        groupsList.innerHTML = '<div class="muted">Loading groups…</div>';
        try {
          const res = await api('/api/groups');
          if (!res.ok) throw new Error('failed');
          const groups = await res.json();
          groupsList.innerHTML = groups.map(g=>`<div class="group-item" data-id="${g._id}"><div><strong>${escape(g.name)}</strong></div><div class="muted small">${g.memberIds?.length||0}</div></div>`).join('');
          groupsList.querySelectorAll('.group-item').forEach(el=>el.onclick = ()=> openGroup(el.dataset.id, el));
        } catch (e) {
          groupsList.innerHTML = '<div class="muted">No groups available</div>';
        }
      }

      createGroup.onclick = async () => {
        const name = newGroupName.value.trim(); if (!name) return;
        try {
          const res = await api('/api/groups', { method:'POST', body: JSON.stringify({ name }) });
          if (res.ok) { newGroupName.value=''; loadGroups(); }
        } catch (e) { console.error(e) }
      };

      async function openGroup(groupId, el){
        currentGroup = groupId;
        document.querySelectorAll('.group-item').forEach(i=>i.classList.remove('active'));
        if (el) el.classList.add('active');
        groupTitle.textContent = 'Group';
        groupSub.textContent = `ID: ${groupId}`;
        noGroup.classList.add('hidden'); groupChat.classList.remove('hidden');
        groupMessages.innerHTML = '<div class="muted">Loading messages…</div>';
        socket.emit('join_group', groupId);
        try {
          const res = await api(`/api/groups/${groupId}/messages`);
          const msgs = await res.json();
          renderMessages(msgs);
          scrollBottom();
        } catch (e) { groupMessages.innerHTML = '<div class="muted">Failed to load messages</div>'; }
      }

      function renderMessages(list){
        groupMessages.innerHTML = (list||[]).map(m=>{
          const me = (m.sender === jwt()._id);
          return `<div class="msg ${me? 'me':''}">${escape(m.content)}<div class="muted" style="font-size:12px;margin-top:6px">${(m.senderName||m.sender)||''} · ${new Date(m.createdAt||Date.now()).toLocaleTimeString()}</div></div>`;
        }).join('');
      }

      function scrollBottom(){ groupMessages.scrollTop = groupMessages.scrollHeight; }

      groupSend.onclick = send;
      groupInput.oninput = () => {
        if (!currentGroup) return;
        socket.emit('typing', { groupId: currentGroup, isTyping: true });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(()=> socket.emit('typing', { groupId: currentGroup, isTyping: false }), 900);
      };

      async function send(){
        const txt = groupInput.value.trim(); if (!txt || !currentGroup) return;
        groupInput.value = '';
        groupMessages.insertAdjacentHTML('beforeend', `<div class="msg me">${escape(txt)}<div class="muted" style="font-size:12px;margin-top:6px">You · ${new Date().toLocaleTimeString()}</div></div>`);
        scrollBottom();
        try {
          await api(`/api/groups/${currentGroup}/messages`, { method:'POST', body: JSON.stringify({ content: txt }) });
        } catch (e) { console.error(e) }
      }

      socket.on('typing', payload => {
        if (payload.groupId && payload.groupId === currentGroup) {
          typing.textContent = payload.isTyping ? `${payload.fromName||payload.from} is typing…` : '';
        }
      });

      socket.on('new_group_message', m => {
        if (!currentGroup) return;
        if (m.groupId === currentGroup) {
          groupMessages.insertAdjacentHTML('beforeend', `<div class="msg ${m.sender===jwt()._id? 'me':''}">${escape(m.content)}<div class="muted" style="font-size:12px;margin-top:6px">${(m.senderName||m.sender)||''} · ${new Date(m.createdAt||Date.now()).toLocaleTimeString()}</div></div>`);
          scrollBottom();
        }
      });

      function escape(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      // init
      loadGroups();
    })();
  </script>
</body>
</html>

