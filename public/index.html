<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat API Tester</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    h2 { margin-top: 32px; }
    fieldset { margin: 12px 0; padding: 12px; }
    label { display: block; margin: 6px 0 2px; }
    input, button, textarea { padding: 8px; font-size: 14px; }
    input, textarea { width: 100%; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    pre { background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 6px; overflow: auto; max-height: 320px; }
    .token { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas; word-break: break-all; background: #f1f5f9; padding: 8px; border-radius: 4px; }
  </style>
  <script>
    let BASE_URL = localStorage.getItem('baseUrl') || window.location.origin;
    let TOKEN = localStorage.getItem('jwt') || '';

    function setBaseUrl() {
      const v = document.getElementById('baseUrl').value.trim();
      if (v) { BASE_URL = v; localStorage.setItem('baseUrl', v); log({ info: 'Base URL set', BASE_URL }); }
    }

    function setToken(t) {
      TOKEN = t || '';
      localStorage.setItem('jwt', TOKEN);
      document.getElementById('tokenOut').textContent = TOKEN || '(none)';
    }

    async function api(path, opts = {}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if (opts.auth !== false && TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
      try {
        const res = await fetch(BASE_URL + path, Object.assign({}, opts, { headers }));
        const text = await res.text();
        let data; try { data = text ? JSON.parse(text) : null; } catch { data = text; }
        return { status: res.status, data };
      } catch (e) {
        log({ fetchError: e && e.message ? e.message : String(e), path: BASE_URL + path });
        throw e;
      }
    }

    function log(obj) {
      const out = document.getElementById('output');
      const time = new Date().toISOString();
      out.textContent = `[${time}]\n` + JSON.stringify(obj, null, 2) + "\n\n" + out.textContent;
    }

    // Auth
    async function registerUser() {
      const username = document.getElementById('reg_username').value;
      const password = document.getElementById('reg_password').value;
      const res = await api('/api/auth/register', { method: 'POST', body: JSON.stringify({ username, password }), auth: false });
      if (res.data && res.data.token) setToken(res.data.token);
      log({ action: 'register', res });
    }
    async function loginUser() {
      const username = document.getElementById('log_username').value;
      const password = document.getElementById('log_password').value;
      const res = await api('/api/auth/login', { method: 'POST', body: JSON.stringify({ username, password }), auth: false });
      if (res.data && res.data.token) setToken(res.data.token);
      log({ action: 'login', res });
    }

    // Posts
    async function listPosts() {
      const res = await api('/api/posts');
      log({ action: 'posts:list', res });
    }
    async function createPost() {
      const content = document.getElementById('post_content').value;
      const res = await api('/api/posts', { method: 'POST', body: JSON.stringify({ content }) });
      log({ action: 'posts:create', res });
      if (res.data && res.data._id) document.getElementById('post_id').value = res.data._id;
    }
    async function updatePost() {
      const id = document.getElementById('post_id').value;
      const content = document.getElementById('post_content').value;
      const res = await api(`/api/posts/${id}`, { method: 'PUT', body: JSON.stringify({ content }) });
      log({ action: 'posts:update', res });
    }
    async function deletePost() {
      const id = document.getElementById('post_id').value;
      const res = await api(`/api/posts/${id}`, { method: 'DELETE' });
      log({ action: 'posts:delete', res });
    }

    // Groups
    async function createGroup() {
      const name = document.getElementById('group_name').value;
      const res = await api('/api/groups', { method: 'POST', body: JSON.stringify({ name }) });
      log({ action: 'groups:create', res });
      if (res.data && res.data._id) document.getElementById('group_id').value = res.data._id;
    }
    async function addUserToGroup() {
      const groupId = document.getElementById('group_id').value;
      const userId = document.getElementById('member_id').value;
      const username = document.getElementById('member_username') ? document.getElementById('member_username').value : '';
      const body = userId ? { userId } : (username ? { username } : {});
      const res = await api(`/api/groups/${groupId}/add-user`, { method: 'POST', body: JSON.stringify(body) });
      log({ action: 'groups:add-user', res });
    }
    async function sendGroupMessage() {
      const groupId = document.getElementById('group_id').value;
      const message = document.getElementById('group_message').value;
      const res = await api(`/api/groups/${groupId}/messages`, { method: 'POST', body: JSON.stringify({ message }) });
      log({ action: 'groups:send-message', res });
    }
    async function listGroupMessages() {
      const groupId = document.getElementById('group_id').value;
      const res = await api(`/api/groups/${groupId}/messages`);
      log({ action: 'groups:list-messages', res });
    }

    // Direct messages
    async function sendDirectMessage() {
      const userId = document.getElementById('dm_user_id').value;
      const username = document.getElementById('dm_username') ? document.getElementById('dm_username').value : '';
      const content = document.getElementById('dm_content').value;
      const body = userId ? { receiverId: userId, content } : { username, content };
      const res = await api('/api/direct-messages/send', { method: 'POST', body: JSON.stringify(body) });
      log({ action: 'dm:send', res });
    }
    async function listDirectMessages() {
      const userIdOrName = document.getElementById('dm_user_id').value || (document.getElementById('dm_username') ? document.getElementById('dm_username').value : '');
      const res = await api(`/api/direct-messages/${encodeURIComponent(userIdOrName)}`);
      log({ action: 'dm:list', res });
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('baseUrl').value = BASE_URL;
      document.getElementById('tokenOut').textContent = TOKEN || '(none)';
    });
  </script>
  </head>
  <body>
    <h1>Chat API Tester</h1>

    <fieldset>
      <legend>Config</legend>
      <label for="baseUrl">Base URL</label>
      <input id="baseUrl" placeholder="http://localhost:3000" />
      <div class="actions">
        <button onclick="setBaseUrl()">Set Base URL</button>
        <button onclick="setToken('')">Clear Token</button>
      </div>
      <div style="margin-top:8px">Token: <span class="token" id="tokenOut"></span></div>
    </fieldset>

    <h2>Auth</h2>
    <div class="row">
      <fieldset>
        <legend>Register</legend>
        <label>Username</label>
        <input id="reg_username" placeholder="alice" />
        <label>Password</label>
        <input id="reg_password" type="password" placeholder="Password123!" />
        <div class="actions"><button onclick="registerUser()">Register</button></div>
      </fieldset>
      <fieldset>
        <legend>Login</legend>
        <label>Username</label>
        <input id="log_username" placeholder="alice" />
        <label>Password</label>
        <input id="log_password" type="password" placeholder="Password123!" />
        <div class="actions"><button onclick="loginUser()">Login</button></div>
      </fieldset>
    </div>

    <h2>Posts</h2>
    <fieldset>
      <label>Post ID</label>
      <input id="post_id" placeholder="(auto from create)" />
      <label>Content</label>
      <textarea id="post_content" rows="2" placeholder="Hello world"></textarea>
      <div class="actions">
        <button onclick="listPosts()">List</button>
        <button onclick="createPost()">Create</button>
        <button onclick="updatePost()">Update</button>
        <button onclick="deletePost()">Delete</button>
      </div>
    </fieldset>

    <h2>Groups</h2>
    <fieldset>
      <label>Group ID</label>
      <input id="group_id" placeholder="(auto from create)" />
      <label>Name</label>
      <input id="group_name" placeholder="General" />
      <label>Member UserId</label>
      <input id="member_id" placeholder="<BOB_USER_ID>" />
      <label>Member Username (alternative)</label>
      <input id="member_username" placeholder="bob" />
      <label>Message</label>
      <input id="group_message" placeholder="Hi group" />
      <div class="actions">
        <button onclick="createGroup()">Create Group</button>
        <button onclick="addUserToGroup()">Add Member</button>
        <button onclick="sendGroupMessage()">Send Message</button>
        <button onclick="listGroupMessages()">List Messages</button>
      </div>
    </fieldset>

    <h2>Direct Messages</h2>
    <fieldset>
      <label>Other UserId</label>
      <input id="dm_user_id" placeholder="<OTHER_USER_ID>" />
      <label>Other Username (alternative)</label>
      <input id="dm_username" placeholder="bob" />
      <label>Content</label>
      <input id="dm_content" placeholder="Hi there" />
      <div class="actions">
        <button onclick="sendDirectMessage()">Send DM</button>
        <button onclick="listDirectMessages()">List DMs</button>
      </div>
    </fieldset>

    <h2>Output</h2>
    <pre id="output"></pre>
  </body>
</html>